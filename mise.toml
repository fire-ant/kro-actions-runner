# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2025
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

# mise configuration for tool version management and task running
# Install tools: mise install
# Run tasks: mise run <task>
# List available tasks: mise tasks

[tools]
# Core language runtimes
go = "1.25.0"
node = "22"        # LTS, for prettier
python = "3.12"    # for pre-commit, yamllint
ruby = "3.3"       # for markdownlint

# Development tools
golangci-lint = "latest"
shfmt = "latest"
yamlfmt = "0.20.0"
shellcheck = "0.11.0.1"
"npm:prettier" = "latest"    # Installed via npm, but also in package.json for version locking

[env]
# Auto-detect docker or podman
DOCKER_CMD = "{{ if exec('which docker') }}docker{{ else if exec('which podman') }}podman{{ else }}docker{{ end }}"

[tasks.test]
description = "Run Go tests"
run = "go test -v ./..."

[tasks.fmt]
description = "Format all code files"
run = [
    "go fmt ./...",
    "shfmt -l -w -s -i 4 .",
    "yamlfmt -dstar **/*.{yaml,yml}",
    "prettier . --write"
]

[tasks.lint]
description = "Run all linters"
run = [
    "golangci-lint run",
    "yamllint .",
    "shellcheck $(find . -name '*.sh' -not -path './.*' 2>/dev/null || true)",
    "shfmt -d -s -i 4 ."
]

[tasks.build]
description = "Build the kar binary"
run = "go build -o bin/kar ./cmd/kar"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf bin/"

[tasks.install-hooks]
description = "Install pre-commit hooks"
run = "pre-commit install --install-hooks"

[tasks.check]
description = "Run all checks (format, lint, test)"
depends = ["fmt", "lint", "test"]

[tasks.setup]
description = "Set up development environment (install tools and hooks)"
run = [
    "npm install",           # Install Node.js dependencies (prettier)
    "mise run install-hooks" # Install pre-commit hooks
]
