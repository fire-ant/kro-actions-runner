# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2025
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################

# mise configuration for tool version management and task running
# Install tools: mise install
# Run tasks: mise run <task>
# List available tasks: mise tasks

[tools]
# Core language runtimes
go = "1.25.0"
python = "3.12"    # for pre-commit, yamllint

# Development tools
golangci-lint = "latest"
shfmt = "latest"
yamlfmt = "0.20.0"
shellcheck = "0.10.0"
"npm:prettier" = "latest"    # Installed via npm, but also in package.json for version locking

# Kubernetes and testing tools
kubectl = "latest"
kind = "latest"
helm = "latest"
kuttl = "latest"

[env]
# Docker command (defaults to docker, set to podman if needed)
DOCKER_CMD = "docker"

# Kubernetes testing configuration
KIND_CLUSTER_NAME = "kro-test"
KUTTL_NAMESPACE = "arc-runners"
CONTROLLER_NS = "arc-systems"

[tasks.test]
description = "Run Go tests"
run = "go test -v ./..."

[tasks.fmt]
description = "Format all code files"
run = [
    "go fmt ./...",
    "shfmt -l -w -s -i 4 .",
    "yamlfmt -dstar **/*.{yaml,yml}"
]

[tasks.lint]
description = "Run all linters"
run = [
    "golangci-lint run",
    "yamllint .",
    "shellcheck $(find . -name '*.sh' -not -path './.*' 2>/dev/null || true)",
    "shfmt -d -s -i 4 ."
]

[tasks.build]
description = "Build the kar binary"
run = "go build -o bin/kar ./cmd/kar"

[tasks.clean]
description = "Clean build artifacts"
run = "rm -rf bin/"

[tasks.install-hooks]
description = "Install pre-commit hooks"
run = "pre-commit install --install-hooks"

[tasks.check]
description = "Run all checks (format, lint, test)"
depends = ["fmt", "lint", "test"]

[tasks.setup]
description = "Set up development environment (install tools and hooks)"
run = "mise run install-hooks"

# Cluster management tasks
[tasks."cluster:create"]
description = "Create kind cluster for testing"
run = [
    "kind create cluster --name ${KIND_CLUSTER_NAME} --config test/fixtures/kind/kind-config.yaml",
    "kubectl cluster-info --context kind-${KIND_CLUSTER_NAME}"
]

[tasks."cluster:delete"]
description = "Delete kind cluster"
run = "kind delete cluster --name ${KIND_CLUSTER_NAME}"

[tasks."cluster:setup"]
description = "Set up cluster with KRO, ARC, and prerequisites"
depends = ["cluster:create"]
run = [
    "test/scripts/install-kro.sh",
    "test/scripts/install-arc.sh",
    "test/scripts/load-image.sh"
]

[tasks."cluster:setup:localstack"]
description = "Set up cluster with KRO, ARC, LocalStack, and ACK EC2 controller"
depends = ["cluster:setup"]
run = [
    "test/scripts/install-localstack.sh",
    "test/scripts/install-ack-ec2.sh"
]

[tasks."cluster:reset"]
description = "Delete and recreate cluster from scratch"
run = [
    "mise run cluster:delete || true",
    "mise run cluster:setup"
]

[tasks."cluster:logs"]
description = "Show logs for key components"
run = [
    "echo '=== KRO Logs ==='",
    "kubectl logs -n kro-system -l app=kro --tail=50 || echo 'KRO logs not available'",
    "echo '=== ARC Logs ==='",
    "kubectl logs -n ${CONTROLLER_NS} -l app.kubernetes.io/name=gha-runner-scale-set-controller --tail=50 || echo 'ARC logs not available'"
]

[tasks."cluster:status"]
description = "Show cluster status"
run = [
    "kubectl get nodes",
    "kubectl get pods -n kro-system",
    "kubectl get pods -n ${CONTROLLER_NS}",
    "kubectl get rgd",
    "kubectl get resourcegraphs -A"
]

# Integration testing tasks
[tasks."test:e2e"]
description = "Run end-to-end kuttl tests"
run = [
    "mise run build",
    "${DOCKER_CMD} build -t kro-actions-runner:latest .",
    "kubectl kuttl test --config test/e2e/kuttl-test.yaml"
]

[tasks."test:e2e:pod-runner"]
description = "Run only pod-runner test case"
run = [
    "mise run build",
    "${DOCKER_CMD} build -t kro-actions-runner:latest .",
    "kubectl kuttl test --config test/e2e/kuttl-test.yaml --test pod-runner"
]

[tasks."test:e2e:kar"]
description = "Run only kar binary integration test (main test)"
run = [
    "mise run build",
    "${DOCKER_CMD} build -t kro-actions-runner:latest .",
    "kubectl kuttl test --config test/e2e/kuttl-test.yaml --test kar-integration"
]

[tasks."test:e2e:ec2"]
description = "Run only EC2 runner test case (requires LocalStack and ACK)"
run = [
    "mise run build",
    "${DOCKER_CMD} build -t kro-actions-runner:latest .",
    "kubectl kuttl test --config test/e2e/kuttl-test.yaml --test ec2-runner"
]

[tasks."test:e2e:skip-ec2"]
description = "Run all e2e tests except EC2 runner (no LocalStack required)"
env = { SKIP_EC2_TESTS = "true" }
run = [
    "mise run build",
    "${DOCKER_CMD} build -t kro-actions-runner:latest .",
    "kubectl kuttl test --config test/e2e/kuttl-test.yaml"
]

[tasks."test:integration"]
description = "Run main kar integration test (fastest validation)"
depends = ["test:e2e:kar"]

[tasks."test:all"]
description = "Run unit and integration tests"
run = [
    "mise run test",
    "mise run test:e2e"
]
