# SPDX-license-identifier: Apache-2.0
##############################################################################
# Copyright (c) 2025
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
name: Integration Tests
on:
  workflow_dispatch:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "master"
jobs:
  kar-integration:
    name: kar binary integration test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # 6.0.0
        with:
          persist-credentials: false

      - name: Install mise
        uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2
        with:
          version: "2026.1.6"
          install: true
          cache: true

      - name: Run kar integration test
        run: mise run test:e2e:kar

      - name: Show cluster logs on failure
        if: failure()
        run: |
          echo "=== KRO Logs ==="
          kubectl logs -n kro-system -l app=kro --tail=100 || echo 'KRO logs not available'
          echo "=== ARC Logs ==="
          kubectl logs -n arc-systems -l app.kubernetes.io/name=gha-runner-scale-set-controller --tail=100 || echo 'ARC logs not available'
          echo "=== kar Pod Logs ==="
          kubectl logs -n arc-runners test-kar-runner --tail=100 || echo 'kar pod logs not available'
          echo "=== Runner Pod Logs ==="
          kubectl logs -n arc-runners test-runner-jit-job --tail=100 || echo 'runner pod logs not available'
