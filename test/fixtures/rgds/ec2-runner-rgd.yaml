apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: ec2-runner
  labels:
    # This label is used for RGD discovery by kro-actions-runner
    # Must match the ACTIONS_RUNNER_SCALE_SET_NAME env var in the runner pods
    # AND must match the runnerScaleSetName in the ARC Helm values
    actions.github.com/scale-set-name: "slapchop-linux-builders"
spec:
  schema:
    apiVersion: v1alpha1
    kind: EC2Runner
    spec:
      # Runner name (also used as the secret name created by ARC)
      runnerName: string
      # AMI ID for the runner instance (should be a GitHub Actions runner AMI)
      imageID: string | default = "ami-000001"
      # Instance type
      instanceType: string | default = "t3.medium"
      # Subnet ID (required for EC2 instances)
      subnetID: string

  resources:
    # Reference the ARC-created secret (wait for it to exist)
    - id: jitSecret
      externalRef:
        apiVersion: v1
        kind: Secret
        metadata:
          name: ${schema.spec.runnerName}

    # The actual EC2 runner Instance
    - id: runnerInstance
      readyWhen:
        # Instance is ready when it's terminated (workflow completed)
        # In LocalStack, instances run as Docker containers
        - ${runnerInstance.status.instanceState.name == "terminated" || runnerInstance.status.instanceState.name == "stopped"}
      template:
        apiVersion: ec2.services.k8s.aws/v1alpha1
        kind: Instance
        metadata:
          name: ${schema.spec.runnerName}
        spec:
          # AMI ID (for LocalStack, this should match a tagged Docker image)
          imageID: ${schema.spec.imageID}
          # Instance type
          instanceType: ${schema.spec.instanceType}
          # Subnet ID (required by ACK)
          subnetID: ${schema.spec.subnetID}
          # User data script to run the GitHub Actions runner
          # Must be base64-encoded
          # This script will:
          # 1. Extract the JIT config from the secret
          # 2. Run the GitHub Actions runner
          # 3. Shutdown the instance when complete
          userData: |
            ${base64encode(`#!/bin/bash
            set -e

            # Extract JIT config from secret
            export ACTIONS_RUNNER_INPUT_JITCONFIG='${jitSecret.data[".jitconfig"]}'
            export RUNNER_NAME='${schema.spec.runnerName}'

            # Run the GitHub Actions runner
            cd /home/runner
            ./run.sh

            # Shutdown the instance after workflow completes
            # This signals to KRO that the runner is done
            shutdown -h now
            `)}
          # Tags for identification
          tags:
            - key: Name
              value: ${schema.spec.runnerName}
            - key: Type
              value: github-actions-runner
            - key: ManagedBy
              value: kro-actions-runner
